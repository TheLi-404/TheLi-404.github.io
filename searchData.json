[{"title":"打造内大最强路由器（五）：番外：白嫖校园网、路由器不断电","url":"/20210427-2015.html","content":"## 白嫖校园网\n**前言：本博文内容仅供学习研究使用，切勿用于其他违法用途！根据本博文所进行的一切行为与博主无关，后果由行为人本人自己承担！**\n* IPv6免费上网\n在大多数支持IPv6的校园网中，IPv6一般是免费开放的。所以可以通过IPv6来连接一个外部服务器，用这个外部服务器代理全部流量实现免费上网。\n不过，既然你都有钱买服务器了，那为什么还付不起网费呢？要知道内大的网费一个月才15，全国数一数二的便宜。\n* 53端口连接外网\n具体原理我也不太懂，但内大的校园网确实可以在未认证的情况下成功查询DNS，也就是可以通过53端口连接到外网。\n![img1](/images/blog6img1.png)\n也有可能连67、68端口也是开放的，详细了解可以看参考资料。\n和IPv6一样，只需要一台外部服务器就可以搞定。\n但，还是那句话，还差这点钱？\n\n\n## 路由器不断电\n内大宿舍区在11点半停电，早上7点之前通电，这点可以理解，但也很是头疼。\n想要路由器不断电，那就得配备一个外部电源。\n* 快充充电宝+快充（12V）诱骗线\n![img2](/images/blog6img2.png)\n这个方案是性价比最高的方案，但缺点也很致命。\n日常只需要充电器连接充电宝，充电宝连接路由器就可以了。\n但在停电的时候，路由器也会停电一瞬间，导致路由器重启。\n换句话讲，灯一黑，你的游戏也输了（笑）。\n另外，并不是所有的充电宝都支持充电的同时又能以12V快充输出。\n所以这个方案并不好。\n* 路由器UPS\n优点在于停电的瞬间路由器不断电，缺点在于性价比低、容量小、品质参差不齐。\n建议有钱人选择这种方式。\n![img3](/images/blog6img3.png)\n\n\n## 参考资料\n[利用openVPN实现udp53,67,68端口绕过校园网认证上网](https://zgao.top/%E5%88%A9%E7%94%A8openvpn%E5%AE%9E%E7%8E%B0udp536768%E7%AB%AF%E5%8F%A3%E7%BB%95%E8%BF%87%E6%A0%A1%E5%9B%AD%E7%BD%91%E8%AE%A4%E8%AF%81%E4%B8%8A%E7%BD%91/)","tags":["技术"]},{"title":"打造内大最强路由器（四）：细节优化：IPv6穿透、DNS设置、断网重连","url":"/20210401-1515.html","content":"## IPv6\n在IPv4地址日趋不足的今天，IPv6可谓是未来的趋势。而在大部分的校园网中，IPv6地址只分配一次，下级设备则不再进行分配。\n所以要手动处理一下，可以有以下几种方法：\n* 给IPv6部分也进行多拨、负载均衡\n这应该是最符合多拨理念的处理方式，但也是最难的方式，而且IPv6只能在路由器本身使用，客户端想用的话也许还得进行NAT。\n[为lean大源码的多播插件添加ipv6负载均衡](https://www.right.com.cn/forum/thread-760177-1-1.html)\n* 对IPv6进行NAT\n极力不推荐这种方式，因为IPv6的出现就是为了解决IPv4地址不够、运营商对其进行NAT的问题。而对IPv6进行NAT，反而会导致IPv6最重要的特性丢失，那我要这IPv6有啥用？\n* IPv6中继\n此方法虽然能让路由器和客户端都能使用原生IPv6地址，但是此方法不稳定，会导致IPv6部分偶尔断网，不推荐使用。\n* IPv6穿透\n引用一位[博主](https://www.polarxiong.com/archives/%E6%95%99%E8%82%B2%E7%BD%91DD-WRT-OpenWrt%E7%94%A8%E4%B8%8AIPv6-%E4%BB%A5%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%E4%B8%BA%E4%BE%8B.html)的一段话，我觉得他说得很好。\n{% blockquote %}\n“穿透”说白了就是把路由器的内网暴露在网线那头的公网上（希望你听得懂），只不过这里是只把IPv6网络暴露在公网上。这样当我的电脑或手机连上路由器的时候，对于IPv6网络而言，我的电脑或手机是直接连上公网的（理解成没有经过路由器）；也可以理解成对于IPv6而言，路由器是工作在交换机模式，对于公网而言路由器是透明的，DHCPv6服务器能直接看到我的电脑或手机，没有路由器挡着。这样电脑或手机就相当于是直接连着网线的，显然能获取到IPv6地址了。\n{% endblockquote %}\n这种方式就是把路由器的上游和路由器的下游连接起来，组成一条“链”，下游设备通过这条“链”直接连接校园网，所以能获取到IPv6地址。\n但因为路由器本身并不在这条“链”上，所以路由器自身就无法使用IPv6了。不过也不是没有解决办法，后面详谈。\n此方法适用于能免费使用IPv6的校园网。\n\n\n## IPv6穿透的实现\n操作很简单，但需要固件有```ebtables```软件包。\n* 关闭```odhcpd```并禁止自启，防止它分配IPv6\n```\n/etc/init.d/odhcpd stop\n/etc/init.d/odhcpd disable\n```\n* 在自动认证脚本的后面加上两行代码\n执行```vi /etc/init.d/autologin```，然后通过方向键将光标移动到最后一行，按```o```键在当前行的下方添加内容。\n```\nebtables -t broute -A BROUTING -p ! ipv6 -j DROP -i eth0.2\nbrctl addif br-lan eth0.2\n```\n保存退出。\n其中这里的```eth0.2```大有讲究，这个接口所连接的网线必须插在墙上的网口，而不是无线AP上的网口。\n无线AP就是广播校园WIFI的白色盒子，这个盒子加了一些额外的规则，如果识别到你获取了IPv6地址却没有获取IPv4内网地址的话，会关闭这条线路上的IPv6连接。\n如果你这里是```eth0.3```的网口连接着墙上的网口的话，那就改成```eth0.3```。\n* 允许IPv6 DNS解析\n在```网络```->```DHCP/DNS```->```高级设置```里，把```禁止解析 IPv6 DNS 记录```的勾去掉，```保存&应用```。\n重启路由器，访问[IPv6测试网站](https://test-ipv6.com/index.html.zh_CN)来测试效果。\n![img1](/images/blog5img1.png)\n它这里甚至能识别我们用了隧道（穿透）。\n* 路由器自身获取IPv6\n在```网络```->```接口```页面```添加新接口```，协议选择```DHCPv6 客户端```，接口选择没被穿透的外网接口，```防火墙设置```里将它分配到```wan```，```保存&应用```。这样路由器本身就能获取到IPv6地址了，对于需要在路由器上下种子的人来说很有帮助。\n![img2](/images/blog5img2.png)\n![img3](/images/blog5img3.png)\n\n\n## DNS设置\n内大自己的DNS服务器实在是太烂了！\nOpenWrt上能设置DNS的地方实在是太多了！\n* 每一个外网接口能设置DNS\n* 内网接口上能设置DNS\n* ```网络```->```DHCP/DNS```里能设置DNS\n* 各种各样的第三方软件包里能设置DNS\n\n这其中有的是功能不相同的，有的是功能相同的，所以就很容易造成各种混乱与冲突。\n所以我建议像我这样，让路由器要求客户端自己解析，并指定解析服务器。\n进入```网络```->```接口```页面，修改```LAN```口设置。\n划到下方，在```DHCP 服务器```->```高级设置```里，勾选```强制```，并在```DHCP 选项```里填上```6,114.114.114.114,119.29.29.29```。\n其中这里的```6```是参数，不可删除；```114.114.114.114,119.29.29.29```是DNS服务器，可以换成其他的，用英文逗号分隔。\n![img4](/images/blog5img4.png)\n**注意，使用闭源驱动的固件在修改```LAN```口设置的时候会导致无线关闭！**\n在```保存&应用```前，先检查是否是用网线连接了路由器，设置完之后记得去```网络```->```无线```页面```重启无线```。\n\n通过WIFI重新连接路由器，查看连接详情。设置正确的话，应该是像我这样能看到DNS服务器的。\n![img5](/images/blog5img5.png)\n\n\n## 断网重连\n有时候总会有一些奇怪的断网问题，原因未知。\n为了保证使用体验，还是写了一个断网重连模块。\n* 这次我们放在 /root 下\n```\ncd root\nvi reconnect\n```\n* 复制以下代码，并把28、29行的接口、接口名、关键参数改为自己的，然后粘贴到刚刚创建的文件里去\n请注意，**接口名务必和创建接口时填入的接口名大小写一致**。\n```\n#!/bin/sh\n\nreconnect(){\n\tfor n in 1 2 3\n\tdo\n\t\tping -c 1 -I $1 www.baidu.com\n\t\tif [ $? == 0 ];then\n\t\t\tflag=false\n\t\t\tbreak\n\t\telse\n\t\t\tflag=true\n\t\tfi\n\tdone\n\n\tif [ \"$flag\" == true ];then\n\t\tping -I $1 -c 1 202.207.0.6\n\t\tif [ $? != 0 ];then\n\t\t\techo $(date) \"端口$1断线，并且无法ping通校内DNS服务器\" >> /root/log\n\t\t\tifup $2\n\t\t\tsleep 10\n\t\telse\n\t\t\techo $(date) \"端口$1断线\" >> /root/log\n\t\tfi\n\t\tcurl --interface $1 -d \"$3\" http://172.31.99.50:802/include/auth_action.php\n\tfi\n}\n\nVLAN_ID_1=\"eth0.2\"   interface_name_1=wan0   user_1=\"账号1的关键参数\"\nVLAN_ID_2=\"eth0.3\"   interface_name_2=wan1   user_2=\"账号2的关键参数\"\n\nreconnect $VLAN_ID_1 $interface_name_1 $user_1\nreconnect $VLAN_ID_2 $interface_name_2 $user_2\n```\n逻辑也比较简单，多次ping百度，只要有一次通过即视为正常；\n当无法ping通百度但可以ping通校内DNS服务器时，进行认证操作；\n当无法ping通百度也无法ping通校内DNS服务器时，对接口进行重新连接并认证。\n* 给文件添加执行权限\n```\nchmod +x reconnect\n```\n* 启用计划任务\n在```系统```->```计划任务```里，添加以下行：\n```\n*/1 * * * * /root/reconnect\n\n```\n这里的```*/1```表示每分钟执行一次。**请保证末尾至少有一个空白行！**\n![img6](/images/blog5img6.png)\n点击```提交```即可生效。\n如需查看重连记录，可执行```cat /root/log```来查看。\n\n\n## End\n到这里，你的路由器已经是一台受过高等教育的路由器了，拥有非常优秀的体验。\n后续的博文将进行一些无关紧要的研究，敬请期待。\n\n\n## 部分参考资料\n[信息黄埔校园网ipv6路由处理](https://makiras.org/archives/49)","tags":["技术"]},{"title":"打造内大最强路由器（三）：多线多拨实现带宽叠加","url":"/20210331-1029.html","content":"## 什么是多拨\n多拨最开始出现在家庭网络的拨号上网中。比如说，家里已经有了一条电信宽带，而移动充话费时又送了一条宽带。为了充分地利用起这两条宽带，我们把它们接在同一个路由器上，同时并发拨号，并对流量进行负载均衡，实现这两条宽带的带宽叠加，这个操作就叫做双线双拨。而某些地区的运营商存在Bug，能够对一条宽带进行多次拨号，并且实现带宽叠加，这个就叫做单线多拨。\n\n\n## 单线多拨的探索与结果\n根据N年前内大网络中心发布的一篇[公告](https://nic.imu.edu.cn/info/1035/1123.htm)中有提到：\n{% blockquote %}\n网络中心不推荐使用路由器上网，我们推荐使用 http://item.jd.com/436666.html 这种带有ap功能的wifi设备。因为路由器只能获取一个IP地址，多人使用的时候会造成本地的网络拥堵，网速变慢。 ap模式会使每一台连接wifi的设备获取一个独立的IP，各设备之间网速相互不影响。 \n{% endblockquote %}\n显而易见，内大校园网里存在限速，而且是根据IP地址限速的。每个校园网账号登陆后只能获取1个IP地址，所以也可以理解为对账号限速。\n而在目前的测速来看，校园网对于每个账号的限速应该在100Mbps，所以我们只要尝试在同一个路由器上登录多个账号，也许就能实现带宽叠加了。\n\n然而最终根据我的大量测试来看，很遗憾，内大在装修时安装的埋墙线均为百兆，物理限制不可突破，单线多拨不会有网速提升。所以我们把目光还是转向多线多拨吧。\n\n\n## 准备工作\n\n* 需要~~向室友献出py~~拿到多个校园网账号，并按照本系列[上一篇博文](https://lizijiandesu.github.io/20210330-1519)里的教程，拿到这几个账号的关键参数，写成curl命令保存备用。\n* 多根网线以及一个能插网线的电脑。\n* Openwrt固件的路由器，并安装好多拨插件```luci-app-syncdial```及负载均衡```luci-app-mwan3```。\n\n\n## 改LAN口为WAN口\n新路由3只有一个```WAN```口，```LAN```口却有五个，要接入多条宽带的话必须要把部分```LAN```口改成```WAN```口。\n在```网络```->```交换机```页面中进行设置。\n简单来讲，所有的```LAN```口都在同一个```VLAN ID```里；每个```WAN```口则独立占用一个```VLAN ID```。\n\n如果想把某一个接口从```LAN```口改成```WAN```口，则只需要单独创建一行```VLAN ID```，把这个口设置成```untagget```，并把这个口在其他```VLAN ID```中的相应位置改成```关```就行了。```CPU(eth0)```则一律设置成```tagget```。\n\n如图，这里我把```LAN1```改成了```WAN```口。\n![img1](/images/blog4img1.png)\n其中需要记住每个```WAN```口的```VLAN ID```，比如说我这里原来的```WAN```口的```VLAN ID```是2，新改出来的```WAN```口的```VLAN ID```是3。**在命令行中则分别用```eth0.2```、```eth0.3```表示它们。**\n\n\n## 创建多个外网接口\n进入```网络```->```接口```页，把```WAN```和```WAN6```删除，然后点击```添加新接口```。\n这里我建议把原本的```WAN```口命名为```wan0```，新改的```WAN```口命名为```wan1```、```wan2```……\n**记住你此时输入的接口名是大写还是小写，因为创建成功后一律显示为大写，而实际上是有大小写之分的。**\n接口协议选择```DHCP 客户端```,接口选择```eth0.2```、```eth0.3```……这是原来的```WAN```口以及新改出来的```WAN```口。\n![img2](/images/blog4img2.png)\n点```提交```，然后再到```防火墙设置```里，把刚刚创建的接口都绑定到```wan```里，```保存&应用```之后，就可以给这些接口插入宽带了。\n![img3](/images/blog4img3.png)\n如果操作没有问题的话，应该能看到这些```WAN```口已经获取到IP地址了。\n我弄的是双线双拨，所以就把```LAN1```改成了```WAN```口，并创建了两个接口。\n![img4](/images/blog4img4.png)\n请注意此时各个```WAN```口的```MAC 地址```必须不一样。如有重复则修改接口的```高级设置```，自定义一个```MAC 地址```。\n\n\n## 设置负载均衡\n如果不设置的话，流量将只走一条宽带。\n在```网络```->```负载均衡```里，建议把```接口```、```成员```、```策略```、```规则```里的自带内容删除后再进行下面的操作。\n\n* 接口\n添加所有外网接口，其中接口名和刚刚创建的**接口名一致，大小写相等**。\n里面的配置可以仿照我的进行设置。\n![img5](/images/blog4img5.png)\n![img6](/images/blog4img6.png)\n![img7](/images/blog4img7.png)\n* 成员\n有多少个外网接口则创建多少个成员，其中成员名不能和接口名一样，必须有区分，可以像我这样设置。\n![img8](/images/blog4img8.png)\n其中**这里的**```跃点数```表示优先级，如果```跃点数```不一样则**只启用跃点数小的接口**，```跃点数```一样则同时启用；```比重```则决定已启用成员的流量配比。在这里我们全部设为1即可。\n* 策略\n创建一条策略，名称随意。使用的成员为刚刚创建的成员。\n![img9](/images/blog4img9.png)\n* 规则\n创建一条规则，名称随意。分配的策略选择```banlanced```，其他保持默认。\n![img10](/images/blog4img10.png)\n设置完记得保存&应用。\n\n\n## 多拨状态下的自动认证\n只需要对上一篇博文的代码进行略微修改就可以了。\n另外，如果你在上一篇博文里已经创建了```autologin```，则需要先删除后再进行操作，因为那个脚本是面向单拨的。\n```\ncd /etc/init.d\nrm autologin\n```\n复制以下代码到专业的文本编辑器里，把15、16行的接口和账号参数改成自己的。如果需要三拨或者更多拨，则按照格式修改最后几行。\n```\n#!/bin/sh /etc/rc.common\nSTART=99\n\nlogin(){\n\tping -I $1 -c 1 202.207.0.6\n\twhile [ $? != 0 ]\n\tdo\n\t\tsleep 5\n\t\tping -I $1 -c 1 202.207.0.6\n\tdone\n\tcurl --interface $1 -d \"$2\" http://172.31.99.50:802/include/auth_action.php\n}\n\nstart(){\nVLAN_ID_1=\"eth0.2\"   user_1=\"账号1的关键参数\"\nVLAN_ID_2=\"eth0.3\"   user_2=\"账号2的关键参数\"\n\nlogin $VLAN_ID_1 $user_1\nlogin $VLAN_ID_2 $user_2\n}\n```\n```\nvi autologin\n```\n修改完了之后复制到```autologin```，方法就不多赘述了。\n```\nchmod +x autologin\n./autologin enable\n```\n\n\n## 修复多拨产生的问题\n多拨之后虽然能够实现暴力的网速叠加，但是也会出现一些问题，比如说导致某些网页加载不全、微信图片发送不出去、腾讯视频无法观看等，几乎无法日用。\n困扰了很久之后终于找到了解决方案，只需要在```网络```->```防火墙```->```自定义规则```里添加一条规则就行了。\n```\niptables -t nat -I POSTROUTING -j MASQUERADE\n```\n![img11](/images/blog4img11.png)\n添加完记得重启防火墙。\n虽然问题解决了，但它是怎么产生的，这条规则又实现了什么，我是完全不懂（摊手）。所以如果有朋友知道的话，可以在评论区告诉我。\n\n\n## 重启\n关于多拨的所有设置已经做完了，此时重启路由器，并到```状态```->```负载均衡```页面确认所有外网接口是否都在线。\n前往 https://www.speedtest.net/ 测试一下网速。\n![img12](/images/blog4img12.png)\n![img13](/images/blog4img13.png)\n\n\n## 部分参考资料\n[openwrt负载均衡最详细设置---小白基础篇](https://www.right.com.cn/forum/thread-2659746-1-1.html)\n[openwrt负载均衡最详细设置---小白进阶篇](https://www.right.com.cn/forum/thread-2670532-1-1.html)\n[[N1盒子] N1刷入LEAN OPENWRT做旁路网关，导致访问国内网站卡顿](https://www.right.com.cn/forum/thread-506510-1-1.html)","tags":["技术"]},{"title":"打造内大最强路由器（二）：深澜WEB自动认证","url":"/20210330-1519.html","content":"## 零、需求\n内大的校园网是分为无线和有线两个部分。无线部分比较省心，当成功认证之后，你的校园网账号就会绑定当前设备的MAC地址，下次登录时无需重复认证。而有线部分就比较坑了，每当已登录的设备断开后则需要重新认证。\n所以不仅每天起床后都需要手动进行登录认证，就连重启路由器也要认证……不堪其烦，于是摸索自动认证的方法。\n本篇及后续系列篇章的功能都在[ikirby](https://ikirby.me/)的帮助下实现，在此感谢他的帮助。\n\n\n## 一、分析\n认证只需要在 http://172.31.99.50:802/srun_portal_pc.php?ac_id=2& 里输入学号密码就可以了，所以我们需要抓包查看这个过程到底发生了什么。\n\n\n## 二、抓包\n需要用到Chrome或者Edge。在认证页按下F12，选中```Network```。然后输入你的学号密码并登录。可以观察到此时在```Name```的下方多出了一项，我们点开它。\n![img1](/images/blog3img1.png)（个人信息进行了打码处理）\n这是一个POST请求，划到最下面，能看到几项关键的参数：```username```和```password```，也就是你的学号和加密过的密码，所以基本可以判定这个POST请求就是认证的关键了。其他的一些不明所以的参数，更换账号进行对照实验时也不会改变，所以我们可以不再研究，原封不动保留即可。\n![img2](/images/blog3img2.png)\n至于这个密码是怎么加密的，这些参数代表什么，其实并不需要关心，我们只需要在路由器上自动模拟发送这个POST即可。我们先尝试一下。\n\n右键点击```auth_action.php```，选择```Copy，Copy cURL(bath)```，使得它能够在Linux上运行。新建一个空白文件，粘贴进去，继续分析。\n![img3](/images/blog3img3.png)\n\n\n## 三、模拟\n![img4](/images/blog3img4.png)\n可以看到目标URL是 http://172.31.99.50:802/include/auth_action.php ，关键参数为```--data-raw```后面**高亮**的这一句，其他的```-H```都是登录时候的环境参数，是无关变量，猜测服务器不会对这些参数进行验证，可以尝试全部删了。\n于是我们就可以用一条命令模拟这一个登录过程（记得把```关键参数```引号内的内容改为你自己的关键参数）：\n```\ncurl -d “关键参数” http://172.31.99.50:802/include/auth_action.php\n```\n在认证页把账号退出，确认下现在是未认证、上不了网的状态。然后打开路由器后台，```系统```->```TTYD 终端```，把命令复制进去。如图\n（在Linux终端中，粘贴快捷键为```Ctrl```+```Shift```+```v```）\n![img5](/images/blog3img5.png)\n回车执行。\n![img6](/images/blog3img6.png)\n返回了```login_ok```，此时路由器已经连上网了，模拟成功！\n\n\n## 四、自启\n我们的最终目的是实现在路由器开机时就自动进行登录认证，所以我们还需要写一个自启脚本。\n找一个靠谱的文本编辑器，推荐Notepad++、VS Code，把以下内容粘贴进去，并把```关键参数```改为自己账号的参数。\n**（请不要使用微软自带的记事本！！！）**\n```\n#!/bin/sh /etc/rc.common\nSTART=99\n\nstart(){\nping -c 1 202.207.0.6\nwhile [ $? != 0 ]\ndo\n\tsleep 5\n\tping -c 1 202.207.0.6\ndone\ncurl -d \"关键参数\" http://172.31.99.50:802/include/auth_action.php\n}\n```\n原理也挺简单的，认证前需要先获取内网IP，所以可以通过不停地ping学校DNS来判断是否获取到了内网IP。当成功ping通的话就可以开始认证操作了。\n\n改完关键参数后，全选、复制留作备用。\n\n切换到英文输入，在```TTYD 终端```里，执行命令：\n```\ncd /etc/init.d     # 进入/etc/init.d\nvi autologin       # 用vi编辑器创建并编辑文件autologin\n```\n要注意的是，此时是**命令模式**，需要按```i```键进入**插入模式**才可以输入。\n然后把刚刚复制的内容粘贴进去。（再次提醒下，Linux终端里的粘贴快捷键为```Ctrl```+```Shif```t+```v```）\n按```Esc```返回命令模式，输入```:wq```并回车，保存退出。\n![img7](/images/blog3img7.png)\n接下来给刚刚编辑的文件加上执行权限，终端执行：\n```\nchmod +x autologin\n```\n然后设置开机启动项，执行：\n```\n./autologin enable\n```\n\n\n## 五、测试\n进入```系统```->```启动项```页面，查找有没有刚刚我们创建的```autologin```，看下它是不是```已启用```状态。\n![img8](/images/blog3img8.png)\n接着进入```系统```->```重启```页面重启路由器，验证脚本效果。\n\n至此，一个能够满足大部分需求的路由器就配置好了，后面的博文将会进行一些实验性操作，和一些细节性优化。\n\n\n## 部分参考资料\n[OpenWrt的开机启动服务(init scripts)](https://www.cnblogs.com/milton/p/6345621.html)\n[小米路由器mini——Padavan折腾笔记](https://menyifan.com/2016/08/19/mini4/)","tags":["技术"]},{"title":"打造内大最强路由器（一）：新路由3、Breed、固件与基本设置","url":"/20210329-0909.html","content":"## 前言\n本系列博文着重于操作，对于原理层面的知识则不太深究，毕竟我不是专业人士，水平有限。\n\n\n## 选择路由器\n推荐尽量选择在恩山论坛里人气比较高的路由器，这类路由器一般有很多固件可供选择，而且驱动也相对完整，不太容易出现莫名其妙的疑难杂症，性价比也相对很高。\n在这里我选择的是新路由3。它有全千兆的网口，512M的DDR3内存，32M的闪存，MT7621A双核CPU以及1个USB3.0接口，作为寝室公用路由是完全足够的。\n本系列博客也都是以新路由3为标准而写成的。\n\n\n## 刷入Breed（不死）\nBreed的作用相当于手机上的Bootload、Recovery，主要是给路由器更换固件时提供一个入口，有时还起到救砖的作用，所以也有人称它为“不死”。\n现在在售的新路由3已经基本没有全新的了，大多可以让商家帮忙刷好Breed后再寄过来。我的新路由3就是如此，所以我并没有亲身尝试过这一步操作。\n如果你是个强迫症患者，买了全新版本的新路由3的话，可以按照[恩山论坛的教程](https://www.right.com.cn/forum/thread-342918-1-1.html)刷入Breed。\n\n\n## 刷入第三方固件\n~~不刷第三方固件用什么新路由3。~~\n新路由3有丰富的第三方固件资源，常见的有稳定易上手的Pandavan（老毛子），功能强大的Openwrt/Pandorabox，精于流控和多拨的高恪等等。\n本系列博客教程都是基于Openwrt的。\n\n因为我不是很满意网友们编译的Openwrt（软件包冲突或是缺少内核模块），于是我就用lean的源码自己编译了一个固件，使用闭源驱动，仅保留我用得上的功能，有兴趣可以来[尝试一下](https://pan.baidu.com/s/1TLQrYw2n3JiIDF3mNebzmA)，提取码：ilys。\n\n由于新路由3的[USB3.0与2.4Ghz信号有冲突](https://www.zhihu.com/question/28422159)，而且我目前没有外接硬盘的打算，所以固件中暂未加入外接USB的支持。\n\n进入正题，在断电状态下**摁住**路由器后面的**复位键**不放，**插上电源**等待。当路由器的全部指示灯出现了一阵鬼畜的闪烁之后，即可松开复位键，此时已经进入了Breed模式。\n这个时候的路由器不会发射无线信号，所以必须通过网线连接电脑进入Breed控制台。\n电脑端关闭所有的代理服务，浏览器访问192.168.1.1即可见到如下页面：\n![img1](/images/blog2img1.png)\n点击固件```更新```->```常规固件```，勾选“固件”并选择你所下载的固件，点击```上传```、```更新```。\n![img2](/images/blog2img2.png)\n静等进度条走完，固件更新完毕并重启。\n此时请**不要拔掉网线**，因为你的无线功能可能还没有开启。在插着网线的情况下继续进行下列设置。\n\n\n## 基本设置\n浏览器访问192.168.1.1（对，还是这个地址）进入Openwrt的后台，默认用户名和密码分别为：\n```\nroot       #用户名\npassword   #密码\n```\n### 开启无线功能：\n第一步先到```网络```->```无线```页面查看是否启用了WIFI，如果没有，请手动开启。在基本设置里可以设置SSID和密码等相关参数，自行摸索。\n![img3](/images/blog2img3.png)\n在开启了无线功能之后，我们就可以拔掉网线，用Wi-Fi连接路由器继续进行了。\n\n### 路由器时间同步：\n这个算是比较重要的一步，因为每天晚上宿舍断电，可能就会导致路由器的时间出现偏移。当时间偏移到一定程度之后，连校园网认证服务器都会拒绝你的连接请求。\n在```系统```->```系统```里，点击“同步浏览器时间”进行同步。\n顺便把下面的```启用 NTP 客户端```勾上，```保存&应用```。不过这也是一个然并卵的功能，因为当你时间不正确的时候，你就连不上校园网；当你连不上校园网的时候，你就同步不了时间（摊手）。\n所以当你哪天早上起床发现路由器没网，连认证页面都打不开的时候，先来这里检查一下时间是否正确。\n![img4](/images/blog2img4.png)\n~~+1s~~\n\n### 连接网络：\n接下来到```网络```->```接口```里查看WAN口是否是```DHCP 客户端```模式，并且获取到了以10.xx开头的内网IPv4。如果没有的话，点击WAN接口的修改按钮：\n![img5](/images/blog2img5.png)\n将协议切换到```DHCP 客户端```，```保存&应用```。回到```网络```->```接口```页面，等待网络中心给你分配内网IP。\n当成功获取到IPv4地址的时候，你就可以进入[校园网登录页面](http://172.31.99.50:802/srun_portal_pc.php?ac_id=2&)进行认证上网了。\n接口里面的设置只需要做一次，重启也不会丢失。而校园网则需要每次重启之后都进行手动认证，这个操作其实挺烦人的，常常会因为没有认证而导致手机、电脑不自动连接Wi-Fi。至于如何实现在路由器开机时自动进行校园网认证，这个我们后面再谈。\n\n### 端口映射：\n由于公网IPv4地址数量已经逐渐无法满足需求，我国在很多年前就基本不主动分发公网地址了，改为分发内网IP，多个内网用户共用1个公网IP。\n而在校园网里，情况可能就更复杂，除了学校内网之外，可能还隔着一层运营商内网。这种情况下，P2P的连接性，以及连接的稳定性就堪忧了。\n而端口映射就较好的解决了这个问题，它就相当于一个虫洞，直接贯穿客户端至公网IP的某个端口，变相实现了拥有公网IP的效果（拥有部分端口已经可以解决大部分需求了）。\n\n不扯了，开启方法：\n```服务```->```UPnP```，勾选下方的```启动 UPnP 与 NAT-PMP 服务```，```保存&应用```。\n![img6](/images/blog2img6.png)\n如果有支持端口映射的程序在运行的话，相关信息将会显示在这个页面。\n![img7](/images/blog2img7.png)\n\n\n## 未测试的操作：硬件改装、修改EEPROM\n**这些是相对危险的操作，我并未实际测试过！！！**\n\n新路由3的内部结构相对来说不是那么完美，某些地方如果加上电容、屏蔽罩会更好，而且在极端发热（例如挖矿）的环境下会导致里面的硅油漏出来。可以通过改装解决这些问题，参考恩山论坛[帖子](https://www.right.com.cn/forum/thread-506529-1-1.html)。要是有强迫症但是没有动手能力的话，也可以通过某宝解决。\n\nEEPROM分区里主要存储了发射功率相关的参数，刷入好的EEPROM能使你的无线信号和无线传输速率有较为明显的提升。有强迫症需求的话可以参考[这里](https://www.right.com.cn/forum/thread-426288-1-1.html)和[这里](https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=428424&ctid=246)，不要忘记在刷入前备份自己的EEPROM，以及还要[注意修改MAC地址](https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=430518&ctid=246)。\n\n而实际上，我们的寝室只有十多平米，校园网带宽只有百兆，即使不做这些危险操作，满足需求也是绰绰有余的。\n\n\n## 预告\n本篇仅仅是介绍了路由器的一些基本设置，实现了最基本的上网需求。而在后续的博文中，将会陆续实现校园网自动认证、单线多拨实现带宽叠加（伪）、IPv6的实现等，敬请期待。","tags":["技术"]},{"title":"广西移动光猫折腾日记（上）：翻车忏悔录","url":"/20210212-1122.html","content":"## 一、前因\n家里只有一条移动送的50M宽带，附带送了IPTV服务。\n而我家里只有我姐可能需要稍微上网刷一下微信、听听歌。我家地位最低的侄子（在上中学）甚至被严格控制使用网络时间。所以家里人对网络的需求极小，没有专门去购买路由器。\n在我寒假放假回来~~宅家~~的时候才发现，家里的网络状况有多么的糟糕……\n首先，移动送的光猫既当光猫又当路由，而光猫那孱弱的性能根本不足以同时完成这两项工作，这就导致了偶尔在流量多时造成严重的延迟。\n并且在广西，冬天白天气温可达20°C+，加上光猫自身满载的发热量，时不时还会自动重启。\n我甚至连在线视频都不敢看。看视频看到高潮突然被掐断的感觉，就好像你想打个嗝的时候突然有个人往你的嘴里塞了一块面包被强行摁下去一样。\n终于在某一个晚上，怒不可遏的我进入了光猫的后台。于是就有了下面的故事。\n\n## 二、作死\n光猫型号是华为的HS8545M5，固件用的是移动定制的固件。\n光猫贴纸上只给了```user```用户来进入后台，这个用户的权限非常的低，关键的设置项基本上只能看，不能修改，想要进行高级操作必须拿到超级账户。\n大部分地区的移动都是采用同一个超级账户名和密码，但是广西偏要特立独行，弄了一个自己的超级账户和密码，分别为：\n```\nadmin          #用户名\nCmcc10086#     #密码\n```\n进入后台，我们能看到很多眼花缭乱的选项，有很多在路由器上根本没见过，让我这个小白无所适从，不得不一直翻恩山论坛进行学习。\n其中一些帖子提到，网络连接中有一条名叫```TR069```的连接，这条连接是移动专门拿来控制光猫的通道，甚至还有人说移动会通过这条通道投放广告，劫持DNS等等，虽然真实性有待验证，但是删除它总归是没错的。\n![img1](/images/blog1img1.png)\n于是我就进入到了```网络```->```网络连接```->```宽带设置```界面，可以看到```1_TR069_R_VID_45```这条连接,但是它的```删除```按钮是灰色的，点了几下没反应。所以这条连接即便是超级用户也不能将其删除，与网友的说法有悖。一时无聊，点开了另一条连接。\n\n**悲剧就从此开始了。**\n\n凌晨3点多的我早已注意力涣散，双眼几乎失去焦点。只见这条连接的底下也有一个```Delete```，但并没有看清是否可点击。要不点几下试试？心中有一个大胆的想法，迟钝的大脑却没来得及阻止，手指已经摁下去了……\n![img2](/images/blog1img2.png)\n网页随即刷新，在页面消失之前我终于看见了一个关键词：**INTERNET**。\n手指一阵哆嗦，鸡皮疙瘩突然冒了出来！我好像……并不知道这条宽带的PPPoE密码！而开户人正在外地出差，家里老人要用这条宽带看电视。![img3](/images/blog1img3.jpg)\n于是乎，就这样闯下了大祸，接下来的几天都是用流量过日子的。\n\n**所以请读者们记住，移动光猫的后台在进行危险操作时是没有二次确认的！！！**\n\n## 三、自救\n在断网的这一阵子，经过不断地学习，以及通过与同为移动用户的同学的交流~~献出PY~~而得到了以下干货，广西移动的朋友们可能用得上。\n### 广西移动宽带在线服务：\n[宽带密码重置](http://service.gx.10086.cn/operate/pwdRest.jsp)。或者凭短信验证码 or 服务密码直接修改：[宽带密码修改](http://service.gx.10086.cn/operate/pwd.jsp)。\n\n### 以下是新建PPPoE连接时的设置：\n* 封装类型：**PPPoE**；\n* 业务类型：选带有```INTERNET```或者```上网```字样的选项；\n* 连接模式：因为我手上暂时没有路由器，所以还是继续拿光猫当路由器，选```路由```；\n* IP模式：```IPv4&IPv6```或```仅IPV4```。据说由于大多数代理服务器不代理IPv6，所以访问支持IPv6的魔法网页时，浏览器会先尝试用IPv6连接，超时后再采用IPv4连接，这样反而导致了日常浏览网页的速度下降，按需抉择。\n* 填好```用户名```、```密码```；\n* MTU：PPPoE最合适的值应设为1492。专业性的解释请看[这里](https://www.zhihu.com/question/54689598/answer/203006929)。\n* **启用Vlan请务必打勾，否则将拨号失败！**其中我所在地区的```Vlan ID```为66，供广西朋友参考；\n\tSSID端口绑定：勾选第一个，一般第一个指无线网络；\n\tLAN端口绑定：无论有没有接IPTV盒子，都把所有LAN口打勾，绑定互联网。移动的IPTV究竟是什么情况稍后说明；\n\t地址获取方式也选PPPoE；\n\t其他的保持默认即可。\n![img4](/images/blog1img4.png)\n\n### IPTV\n起初最担心的就是这个，因为我并不知道本地区移动IPTV的```Vlan ID```参数，也没有朋友使用移动的IPTV，并且羞于向宽带师傅求救。苦恼了几天，终于在偶然之间发现了移动的营销套路。\n移动前些年一直没拿到IPTV的营业牌照，而在竞争对手联通、电信都纷纷拿到牌照推出自己的IPTV盒子的情况下，移动则另辟蹊径，推出了不需要营业牌照的OTT盒子——“魔百盒”。\n\n* Q：OTT盒子是什么？和IPTV盒子有什么区别？\n\tA：OTT盒子又叫互联网盒子，举个例子，天猫盒子也是OTT盒子，特点是只要能联网就能用。而IPTV盒子和宽带一样，需要拨号才能使用。\n* Q:那既然如此，为什么要苦苦追求IPTV牌照，直接全上OTT盒子不就行了吗？\n\tA：OTT盒子虽然设置简单，但比起IPTV盒子有个致命的缺点，那就是占用带宽。OTT盒子依存于互联网，在看电视的时候，你的电脑不能随意满速下载，因为可能会影响到一旁在看电视的家人，反之同理。而IPTV的电视推流和网络是完全独立的，不会互相干涉影响。\n* 另外，IPTV优势在于直播延迟小，码率高，推流稳定；而OTT盒子优势在于有丰富的点播内容，还能看热门网剧。但移动也不是好欺负的，电视服务虽然免费送，但是很多热门资源都需要开通会员才能看。（你可能会赚，但移动永远不亏）\n\n而我的“IPTV”盒子正是移动的魔百盒，只要LAN口能上网即可。\n自此，这一场闹剧算是告一段落。\n\n## 四、发现\n在这几天的学习当中，我发现了一些奇技淫巧，供大家参考。\n### 删除TR069连接\n```TR069```连接是运营商的保留连接，方便远程管理光猫，甚至就连超级用户也没有情况删除，要想删除甚至要进shell。而有网友发现了一种投机取巧的方法可以在网页上直接删除```TR069```。\n具体操作：在```TR069```的页面右键，点击检查，出现如图页面。\n![img5](/images/blog1img5.png)\n我们再按组合键```ctrl```+```f```，搜索```disabled```，此时应该会出来很多个搜索结果。不要紧张，我们将鼠标悬停在搜索结果上逐个比对，当提示框出现在```删除```按钮上时，就说明这个就是我们的目标，如图所示。\n![img6](/images/blog1img6.png)\n接下来双击搜索目标，然后把整个```disabled```单词全部删除。你会惊奇的发现```删除```按钮已经变为可点击的状态了，此时直接点击```删除```就可以了。\n**此方法仅在广西移动HS8545M5上测试通过，不保证其他设备，以及后续固件可以使用！**\n\n### 在本地查看PPPoE密码\n**此方法在我的光猫的当前版本测试不通过，但在我朋友的光猫上测试通过，效果自测！**\n同样是通过审查元素的方式。打开PPPoE配置页面，我们把目光移到密码框那里。如果你的密码框里像我一样，里面是无数个圆点的话，那你可以放弃了；如果只有6个圆点的话，继续看下去。\n在密码框直接右键，点击检查。把高亮条目中的```type=\"password\"```改成```type=\"text\"```，点击空白处，密码就直接自己显示出来了。\n![img7](/images/blog1img7.png)\n~~不过既然有这功夫审查元素，为什么不直接去网上营业厅重置密码呢？~~\n\n### UPnP\n经朋友提醒发现，大部分光猫是默认关闭UPnP的，可到```应用```->```UPnP配置```页面启用。\n![img8](/images/blog1img8.png)\nUPnP能提高P2P相关连接的成功率。\n\n## 五、后记\n本次对移动光猫的折腾就到此为止了。虽然没带来什么改变，但是依旧感觉收获甚多。\n顺便预告一下，下一次折腾可能就是半年后带着路由器回家，尝试改光猫桥接以及多拨了。据恩山的一位朋友表示，广西移动可以多拨，多拨效果是下行不叠加但是上行叠加了，看起来拿来做种不错。[帖子传送门](https://www.right.com.cn/forum/thread-4069529-1-1.html)\n也不知道上行叠加时的做种是怎么样的，难道是多个IP同时连接下载方？希望知道的朋友告诉我一下。\n\n<span style=\"font-size: 10px\">另外，感谢ikirby对本篇博文提供的帮助（</span>","tags":["技术"]}]