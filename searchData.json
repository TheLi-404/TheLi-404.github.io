[{"title":"打造内大最强路由器（二）：深澜WEB自动认证","url":"/20210330-1519.html","content":"## 零、需求\n内大的校园网是分为无线和有线两个部分。无线部分比较省心，当成功认证之后，你的校园网账号就会绑定当前设备的MAC地址，下次登录时无需重复认证。而有线部分就比较坑了，每当已登录的设备断开后则需要重新认证。\n所以不仅每天起床后都需要手动进行登录认证，就连重启路由器也要认证……不堪其烦，于是摸索自动认证的方法。\n本篇及后续系列篇章的功能都在[ikirby](https://ikirby.me/)的指导下实现，在此感谢他的帮助。\n\n\n## 一、分析\n认证只需要在 http://172.31.99.50:802/srun_portal_pc.php?ac_id=2& 里输入学号密码就可以了，所以我们需要抓包查看这个过程到底发生了什么。\n\n\n## 二、抓包\n需要用到Chrome或者Edge。在认证页按下F12，选中Network。然后输入你的学号密码并登录。可以观察到此时在Name的下方多出了一项，我们点开它。\n![img1](/images/blog3img1.png)（个人信息进行了打码处理）\n这是一个POST请求，划到最下面，能看到几项关键的参数：username和password，也就是你的学号和加密过的密码，所以基本可以判定这个POST请求就是认证的关键了。其他的一些不明所以的参数，更换账号进行对照实验时也不会改变，所以我们可以不再研究，原封不动保留即可。\n![img2](/images/blog3img2.png)\n至于这个密码是怎么加密的，这些参数代表什么，其实并不需要关心，我们只需要在路由器上自动模拟发送这个请求即可。我们先尝试一下。\n\n右键点击auth_action.php，选择Copy，Copy cURL(bath)，使得它能够在Linux上运行。新建一个空白文件，粘贴进去，继续分析。\n![img3](/images/blog3img3.png)\n\n\n## 三、模拟\n![img4](/images/blog3img4.png)\n可以看到目标URL是 http://172.31.99.50:802/include/auth_action.php ，关键参数为“--data-raw”后面**高亮**的这一句，其他的“-H”都是登录时候的环境参数，是无关变量，猜测服务器不会对这些参数进行验证，可以尝试全部删了。\n于是我们就可以用一条命令模拟这一个登录过程（记得把“关键参数”四个字改为你自己的关键参数）：\n```\ncurl -d “关键参数” http://172.31.99.50:802/include/auth_action.php\n```\n在认证页把账号退出，确认下现在是未认证、上不了网的状态。然后打开路由器后台，系统--TTYD终端，把命令复制进去。如图\n（在Linux终端中，粘贴快捷键为Ctrl+Shift+v）\n![img5](/images/blog3img5.png)\n回车执行。\n![img6](/images/blog3img6.png)\n返回了login_ok，此时路由器已经连上网了，模拟成功！\n\n\n## 四、自启\n我们的最终目的是实现在路由器开机时就自动进行登录认证，所以我们还需要写一个自启脚本。\n找一个靠谱的文本编辑器，推荐Notepad++、VS Code，把以下内容粘贴进去，并把关键参数改为自己的参数。\n（其中“#”后面的内容为注释，可以删除。）\n```\n#!/bin/sh /etc/rc.common\nSTART=99                         # 启动优先级：99\n\nstart(){\nping -c 1 202.207.0.6            # 对校园网网关服务器进行1次ping\nwhile [ $? != 0 ]                # 如果上一次ping不通的话\ndo                               # 则执行\n\tsleep 5                      # 等待5秒\n\tping -c 1 202.207.0.6        # 再次ping网关IP\ndone                             # 如果成功ping通了\ncurl -d \"关键参数\" http://172.31.99.50:802/include/auth_action.php\n}\n```\n改完关键参数后，全选、复制留作备用。\n\n这里说一下为什么需要ping学校网关：只有当网络中心给你分配内网IP时才可以进行登录认证，而在高峰期，这个等待时间甚至有可能长达十分钟，所以写一个程序判断是否获取到了IP地址就很有必要。当成功ping通网关的时候，也就证明获取到了IP，可以进行认证操作了。\n\n切换到英文输入，在TTYD终端里，执行命令：\n```\ncd /etc/init.d     # 进入/etc/init.d\nvi autologin       # 用vi编辑器创建并编辑文件autologin\n```\n要注意的是，此时是命令状态，需要按i键进入插入状态才可以输入。\n然后把刚刚复制的内容粘贴进去。（再次提醒下，Linux终端里的粘贴快捷键为Ctrl+Shift+v）\n按Esc返回命令状态，再按英文冒号键（Shift+L右边的键），输入wq，回车退出。\n![img7](/images/blog3img7.png)\n接下来给刚刚编辑的文件加上执行权限，终端执行：\n```\nchmod +x autologin\n```\n然后设置开机启动项，执行：\n```\n./autologin enable\n```\n\n\n## 五、测试\n进入系统--启动项页面，查找有没有刚刚我们创建的autologin，看下它是不是“已启用”状态。\n![img8](/images/blog3img8.png)\n接着进入系统--重启页面重启路由器，验证脚本效果。\n\n至此，一个能够满足大部分需求的路由器就配置好了，后面的博文将会进行一些实验性操作，和一些细节性优化。","tags":["技术"]},{"title":"打造内大最强路由器（一）：新路由3、Breed、固件与基本设置","url":"/20210329-0909.html","content":"## 前言\n本系列博文着重于操作，对于原理层面的知识则不太深究，毕竟我不是专业人士，水平有限。\n\n\n## 选择路由器\n推荐尽量选择在恩山论坛里人气比较高的路由器，这类路由器一般有很多固件可供选择，而且驱动也相对完整，不太容易出现莫名其妙的疑难杂症，性价比也相对很高。\n在这里我选择的是新路由3。它有全千兆的网口，512M的DDR3内存，32M的闪存，MT7621A双核CPU以及1个USB3.0接口，作为寝室公用路由是完全足够的。\n本系列博客也都是以新路由3为标准而写成的。\n\n\n## 刷入Breed（不死）\nBreed的作用相当于手机上的Bootload、Recovery，主要是给路由器更换固件时提供一个入口，有时还起到救砖的作用，所以也有人称它为“不死”。\n现在在售的新路由3已经基本没有全新的了，大多可以让商家帮忙刷好Breed后再寄过来。我的新路由3就是如此，所以我并没有亲身尝试过这一步操作。\n如果你是个强迫症患者，买了全新版本的新路由3的话，可以按照恩山论坛的教程刷入Breed。\n[教程传送门](https://www.right.com.cn/forum/thread-342918-1-1.html)\n\n\n## 刷入第三方固件\n~~不刷第三方固件用什么新路由3。~~\n新路由3有丰富的第三方固件资源，常见的有稳定易上手的Pandavan（老毛子），功能强大的openwrt/Pandorabox，精于流控和多拨的高恪等等。\n因为本系列博客涉及到深澜web自动认证、多拨及负载均衡、校园网IPv6的两种实现方式，所以就选择了可定义程度高的openwrt。\n\n但我试过很多网友编译的openwrt，都不是很满意。大多因为是软件包装太多，造成了各种冲突，或者是出现了各种影响使用的小毛病，亦或者是没有安装内核模块kmod-ebtables导致无法实现后续的IPv6穿透等等。\n基于此，我自己使用lean的源码编译了一个固件，使用闭源驱动，进行了最大限度的精简，仅保留了后续需要的软件包。[固件下载传送门]()\n由于新路由3的[USB3.0与2.4Ghz信号有冲突](https://www.zhihu.com/question/28422159)，并且在后续的IPv6穿透中路由器自身无法获取IPv6地址的原因，我砍掉了USB相关的全部功能。\n\n进入正题，在断电状态下**摁住**路由器后面的**复位键**不放，**插上电源**等待。当路由器的全部指示灯出现了一阵鬼畜的闪烁之后，即可松开复位键，此时已经进入了Breed模式。\n这个时候的路由器不会发射无线信号，所以必须通过网线连接电脑进入Breed控制台。\n电脑端关闭所有的代理服务，浏览器访问192.168.1.1即可见到如下页面：\n![img1](/images/blog2img1.png)\n点击固件更新--常规固件，勾选“固件”并选择你所下载的固件，点击上传。\n![img2](/images/blog2img2.png)\n确认固件的MD5值无误后点击更新。\n![img3](/images/blog2img3.png)\n静等进度条走完，固件更新完毕并重启。\n此时请**不要拔掉网线**，因为你的无线功能可能还没有开启。在插着网线的情况下继续进行下列设置。\n\n\n## 基本设置\n浏览器访问192.168.1.1（对，还是这个地址）进入openwrt的后台，默认用户名和密码分别为：\n```\nroot       #用户名\npassword   #密码\n```\n### 开启无线功能：\n第一步先到网络--无线页面查看是否启用了WLAN，如果没有，请手动开启。在基本设置里可以设置SSID和密码等相关参数，自行摸索。\n![img4](/images/blog2img4.png)\n在开启了无线功能之后，我们就可以拔掉网线，用Wi-Fi连接路由器继续进行了。\n\n### 路由器时间同步：\n这个算是比较重要的一步，因为每天晚上宿舍断电，可能就会导致路由器的时间出现偏移。当时间偏移到一定程度之后，连校园网认证服务器都会拒绝你的连接请求。\n在系统--系统里，点击“同步浏览器时间”进行同步。\n顺便把下面的“启用 NTP 客户端”勾上，保存&应用。不过这也是一个然并卵的功能，因为当你时间不正确的时候，你就连不上校园网；当你连不上校园网的时候，你就同步不了时间（摊手）。\n所以当你哪天早上起床发现路由器没网，连认证页面都打不开的时候，先来这里检查一下时间是否正确。\n![img5](/images/blog2img5.png)\n~~+1s~~\n\n### 连接网络：\n接下来到网络--接口里查看WAN口是否是DHCP客户端模式，获取到了以10.xx开头的内网IPv4。如果没有的话，点击WAN接口的修改按钮：\n![img6](/images/blog2img6.png)\n将协议切换到DHCP客户端，保存&应用。回到网络--接口页面，等待网络中心给你分配内网IP。\n当成功获取到IPv4地址的时候，你就可以进入[校园网登录页面](http://172.31.99.50:802/srun_portal_pc.php?ac_id=2&)进行认证上网了。\n接口里面的设置只需要做一次，重启也不会丢失。而校园网则需要每次重启之后都进行手动认证，这个操作其实挺烦人的，常常会因为没有认证而导致手机、电脑不自动连接Wi-Fi。至于如何实现在路由器开机时自动进行校园网认证，这个我们后面再谈。\n\n### 端口映射：\n由于公网IPv4地址数量已经逐渐无法满足需求，我国在很多年前就基本不主动分发公网地址了，改为分发内网IP，多个内网用户共用1个公网IP。\n而在校园网里，情况可能就更复杂，除了学校内网之外，可能还隔着一层运营商内网。这种情况下，P2P的连接性，以及连接的稳定性就堪忧了。\n而端口映射就较好的解决了这个问题，它就相当于一个虫洞，直接贯穿客户端至公网IP的端口，变相实现了拥有公网IP的效果（拥有部分端口已经可以解决大部分需求了）。\n\n不扯了，开启方法：\n服务--UPnP，勾选下方的“启动 UPnP 与 NAT-PMP 服务”，保存&应用。\n![img7](/images/blog2img7.png)\n如果有支持端口映射的程序在运行的话，相关信息将会显示在这个页面。\n![img8](/images/blog2img8.png)\n\n### 魔法上网：\n其实本人是用不着在路由器上开启这个功能的，但是为了满足室友们的求知欲，于是我在固件中加入了PassWall。\n![img9](/images/blog2img9.png)\n入口在服务--PassWall里。\n如果你知道这是什么，那自然不必多言如何设置了。\n![img10](/images/blog2img10.png)\n\n\n## 未测试的操作：硬件改装、修改EEPROM\n**这些是相对危险的操作，我并未实际测试过！！！**\n\n新路由3的内部结构相对来说不是那么完美，某些地方如果加上电容、屏蔽罩会更好，而且在极端发热（例如挖矿）的环境下会导致里面的硅油漏出来。可以通过改装解决这些问题，参考恩山论坛[帖子](https://www.right.com.cn/forum/thread-506529-1-1.html)。要是有强迫症但是没有动手能力的话，也可以通过淘宝解决。\n\nEEPROM分区里主要存储了发射功率相关的参数，刷入好的EEPROM能使你的无线信号和无线传输速率有较为明显的提升。有强迫症需求的话可以参考[这里](https://www.right.com.cn/forum/thread-426288-1-1.html)和[这里](https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=428424&ctid=246)，不要忘记在刷入前备份自己的EEPROM，以及还要[注意修改MAC地址](https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=430518&ctid=246)。\n\n而实际上，我们的寝室只有十多平米，校园网带宽只有百兆，即使不做这些危险操作，满足需求也是绰绰有余的。\n\n\n## 预告\n本篇仅仅是介绍了路由器的一些基本设置，实现了最基本的上网需求。而在后续的博文中，将会陆续实现校园网自动认证、单线多拨实现带宽叠加（伪）、IPv6的两种实现方式等，敬请期待。","tags":["技术"]},{"title":"广西移动光猫折腾日记（上）：翻车忏悔录","url":"/20210212-1122.html","content":"## 一、前因\n家里只有一条移动送的50M宽带，附带送了IPTV服务。\n而我家里只有我姐可能需要稍微上网刷一下微信、听听歌。我家地位最低的侄子（在上中学）甚至被严格控制使用网络时间。所以家里人对网络的需求极小，没有专门去购买路由器。\n在我寒假放假回来~~宅家~~的时候才发现，家里的网络状况有多么的糟糕……\n首先，移动送的光猫既当光猫又当路由，而光猫那孱弱的性能根本不足以同时完成这两项工作，这就导致了偶尔在流量多时造成严重的延迟。\n并且在广西，冬天白天气温可达20°C+，加上光猫自身满载的发热量，时不时还会自动重启。\n我甚至连在线视频都不敢看。看视频看到高潮突然被掐断的感觉，就好像你想打个嗝的时候突然有个人往你的嘴里塞了一块面包被强行摁下去一样。\n终于在某一个晚上，怒不可遏的我进入了光猫的后台。于是就有了下面的故事。\n\n## 二、作死\n光猫型号是华为的HS8545M5，固件用的是移动定制的固件。\n光猫贴纸上只给了user用户来进入后台，这个用户的权限非常的低，关键的设置项基本上只能看，不能修改，想要进行高级操作必须拿到超级账户。\n大部分地区的移动都是采用同一个超级账户名和密码，但是广西偏要特立独行，弄了一个自己的超级账户和密码，分别为：\n```\nadmin          #用户名\nCmcc10086#     #密码\n```\n进入后台，我们能看到很多眼花缭乱的选项，有很多在路由器上根本没见过，让我这个小白无所适从，不得不一直翻恩山论坛进行学习。\n其中一些帖子提到，网络连接中有一条名叫“TR069”的连接，这条连接是移动专门拿来控制光猫的通道，甚至还有人说移动会通过这条通道投放广告，劫持DNS等等，虽然真实性有待验证，但是删除它总归是没错的。\n![img1](/images/blog1img1.png)\n于是我就进入到了网络-网络连接-宽带设置界面，可以看到**1_TR069_R_VID_45**这条连接,但是它的**删除**按钮是灰色的，点了几下没反应。所以这条连接即便是超级用户也不能将其删除，与网友的说法有悖。一时无聊，点开了另一条连接。\n\n**悲剧就从此开始了。**\n\n凌晨3点多的我早已注意力涣散，双眼几乎失去焦点。只见这条连接的底下也有一个Delete，但并没有看清是否可点击。“要不点几下试试？”心中有一个大胆的想法，迟钝的大脑却没来得及阻止，手指已经摁下去了……\n![img2](/images/blog1img2.png)\n网页随即刷新，在页面消失之前我终于看见了一个关键词：**INTERNET**。\n手指一阵哆嗦，鸡皮疙瘩突然冒了出来！我好像……并不知道这条宽带的PPPoE密码！而开户人正在外地出差，家里老人要用这条宽带看电视。![img3](/images/blog1img3.jpg)\n于是乎，就这样闯下了大祸，接下来的几天都是用流量过日子的。\n\n**所以请读者们记住，移动光猫的后台在进行危险操作时是没有确认按钮的！！！**\n\n## 三、自救\n在断网的这一阵子，经过不断地学习，以及通过与同为移动用户的同学的交流~~献出PY~~而得到了以下干货，广西移动的朋友们可能用得上。\n### 广西移动宽带在线服务：\n[宽带密码重置](http://service.gx.10086.cn/operate/pwdRest.jsp)。或者凭短信验证码 or 服务密码直接修改：[宽带密码修改](http://service.gx.10086.cn/operate/pwd.jsp)。\n\n### 以下是新建PPPoE连接时的设置：\n* 封装类型：**PPPoE**；\n* 业务类型：选带有**INTERNET**或者**上网**字样的选项；\n* 连接模式：因为我手上暂时没有路由器，所以还是继续拿光猫当路由器，选**路由**；\n* IP模式：IPv4&IPv6或仅IPV4。据说由于大多数代理服务器不代理IPv6，所以访问支持IPv6的魔法网页时，浏览器会先尝试用IPv6连接，超时后再采用IPv4连接，这样反而导致了日常浏览网页的速度下降，按需抉择。\n* 用户名 and 密码填上去；\n* MTU：PPPoE最合适的值应设为1492。专业性的解释请看[这里](https://www.zhihu.com/question/54689598/answer/203006929)。\n* **启用Vlan请务必打勾，否则将拨号失败！**其中我所在地区的Vlan ID为66，供广西朋友参考；\n\tSSID端口绑定把第一个勾上，一般第一个指无线网络；\n\tLAN端口绑定：无论有没有接IPTV盒子，都把所有LAN口打勾，绑定互联网。移动的IPTV究竟是什么情况稍后说明；\n\t地址获取方式也选PPPoE；\n\t其他的保持默认即可。\n![img4](/images/blog1img4.png)\n\n### IPTV\n起初最担心的就是这个，因为我并不知道本地区移动IPTV的Vlan ID参数，也没有朋友使用移动的IPTV，并且羞于向宽带师傅求救。苦恼了几天，终于在偶然之间发现了移动的营销套路。\n移动前些年一直没拿到IPTV的营业牌照，而在竞争对手联通、电信都纷纷拿到牌照推出自己的IPTV盒子的情况下，移动则另辟蹊径，推出了不需要营业牌照的OTT盒子——“魔百盒”。\n* Q：OTT盒子是什么？和IPTV盒子有什么区别？\n\tA：OTT盒子又叫互联网盒子，举个例子，天猫盒子也是OTT盒子，特点是只要能联网就能用。而IPTV盒子和宽带一样，需要拨号才能使用。\n* Q:那既然如此，为什么要苦苦追求IPTV牌照，直接全上OTT盒子不就行了吗？\n\tA：OTT盒子虽然设置简单，但比起IPTV盒子有个致命的缺点，那就是占用带宽。OTT盒子依存于互联网，在看电视的时候，你的电脑不能随意满速下载，因为可能会影响到一旁在看电视的家人，反之同理。而IPTV的电视推流和网络是完全独立的，不会互相干涉影响。\n* 另外，IPTV优势在于直播延迟小，码率高，推流稳定；而OTT盒子优势在于有丰富的点播内容，还能看热门网剧。但移动也不是好欺负的，电视服务虽然免费送，但是很多热门资源都需要开通会员才能看。（你可能会赚，但移动永远不亏）\n\n而我的“IPTV”盒子正是移动的魔百盒，只要LAN口能上网即可。\n自此，这一场闹剧算是告一段落。\n\n## 四、发现\n在这几天的学习当中，我发现了一些奇技淫巧，供大家参考。\n### 删除TR069连接\nTR069连接是运营商的保留连接，方便远程管理光猫，甚至就连超级用户也没有情况删除，要想删除甚至要进shell。而有网友发现了一种投机取巧的方法可以在网页上直接删除TR069。\n具体操作：在TR069的页面右键，点击检查，出现如图页面。\n![img5](/images/blog1img5.png)\n我们再按组合键ctrl+F，搜索disabled，此时应该会出来很多个搜索结果。不要紧张，我们将鼠标悬停在搜索结果上逐个比对，当提示框出现在“**删除**”按钮上时，就说明这个就是我们的目标，如图所示。\n![img6](/images/blog1img6.png)\n接下来双击搜索目标，然后把整个\"disabled\"单词全部删除。你会惊奇的发现“**删除**”按钮已经变为可点击的状态了，此时直接点击**删除**就可以了。\n**此方法仅在广西移动HS8545M5上测试通过，不保证其他设备，以及后续固件可以使用！**\n\n### 在本地查看PPPoE密码\n**此方法在我的光猫的当前版本测试不通过，但在我朋友的光猫上测试通过，效果自测！**\n同样是通过审查元素的方式。打开PPPoE配置页面，我们把目光移到密码框那里。如果你的密码框里像我一样，里面是无数个圆点的话，那你可以放弃了；如果只有6个圆点的话，继续看下去。\n在密码框直接右键，点击检查。把高亮条目中的type=\"**password**\"改成type=\"**text**\"，点击空白处，密码就直接自己显示出来了。\n![img7](/images/blog1img7.png)\n~~不过既然有这功夫审查元素，为什么不直接去网上营业厅重置密码呢？~~\n\n### UPnP\n经朋友提醒发现，大部分光猫是默认关闭UPnP的，可到应用-UPnP配置页面启用。\n![img8](/images/blog1img8.png)\nUPnP主要是提高P2P相关连接的成功率。即使没有公网的移动宽带也可以打开，说不定大内网互联呢。\n\n## 五、后记\n本次对移动光猫的折腾就到此为止了。虽然没带来什么改变，但是依旧感觉收获甚多。\n顺便预告一下，下一次折腾可能就是半年后带着路由器回家，尝试改光猫桥接以及多拨了。据恩山的一位朋友表示，广西移动可以多拨，多拨效果是下行不叠加但是上行叠加了，看起来拿来做种不错。[帖子传送门](https://www.right.com.cn/forum/thread-4069529-1-1.html)\n也不知道上行叠加时的做种是怎么样的，难道是多个IP同时连接下载方？希望知道的朋友告诉我一下。\n\n<span style=\"font-size: 10px\">另外，感谢ikirby对本篇博文提供的帮助（</span>","tags":["技术"]}]